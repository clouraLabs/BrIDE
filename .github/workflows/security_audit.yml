name: Security Audit

on:
  push:
    branches:
      - main
      - 'release/*'
  pull_request:
    branches:
      - main
  schedule:
    # Run security audit every Monday at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  cargo-audit:
    name: Cargo Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run cargo audit
        id: audit
        run: |
          cargo audit --json > audit-results.json || echo "AUDIT_FAILED=true" >> $GITHUB_OUTPUT
          cat audit-results.json

      - name: Parse and report vulnerabilities
        if: steps.audit.outputs.AUDIT_FAILED == 'true'
        run: |
          echo "::error::Security vulnerabilities found in dependencies!"
          cargo audit
          exit 1

      - name: Upload audit results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cargo-audit-results
          path: audit-results.json
          retention-days: 30

  cargo-deny:
    name: Cargo Deny Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          cache: true

      - name: Install cargo-deny
        run: cargo install cargo-deny --locked

      - name: Run cargo deny
        run: cargo deny check

  clippy-security:
    name: Clippy Security Lints
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy
          cache: true

      - name: Install required dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libasound2-dev \
            libfontconfig-dev \
            libwayland-dev \
            libxkbcommon-x11-dev \
            libssl-dev \
            libzstd-dev \
            libvulkan-dev

      - name: Run Clippy with security lints
        run: |
          cargo clippy --workspace --all-targets --all-features -- \
            -W clippy::unwrap_used \
            -W clippy::expect_used \
            -W clippy::panic \
            -W clippy::mem_forget \
            -W clippy::todo \
            -W clippy::unimplemented \
            -W clippy::unreachable

  unsafe-code-audit:
    name: Unsafe Code Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Count unsafe blocks
        id: unsafe-count
        run: |
          UNSAFE_COUNT=$(rg -c "unsafe" --type rust | awk -F: '{sum+=$2} END {print sum}')
          echo "unsafe_count=$UNSAFE_COUNT" >> $GITHUB_OUTPUT
          echo "Found $UNSAFE_COUNT unsafe blocks"

      - name: Generate unsafe code report
        run: |
          echo "# Unsafe Code Audit Report" > unsafe-report.md
          echo "" >> unsafe-report.md
          echo "Total unsafe blocks found: $(rg -c "unsafe" --type rust | awk -F: '{sum+=$2} END {print sum}')" >> unsafe-report.md
          echo "" >> unsafe-report.md
          echo "## Files with unsafe code:" >> unsafe-report.md
          echo "" >> unsafe-report.md
          rg -l "unsafe" --type rust | while read file; do
            count=$(rg -c "unsafe" "$file" | cut -d: -f2)
            echo "- \`$file\`: $count unsafe blocks" >> unsafe-report.md
          done

      - name: Upload unsafe code report
        uses: actions/upload-artifact@v4
        with:
          name: unsafe-code-report
          path: unsafe-report.md
          retention-days: 90

      - name: Comment on PR with unsafe code stats
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('unsafe-report.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-3.0, AGPL-3.0
          comment-summary-in-pr: true

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [cargo-audit, cargo-deny, clippy-security, unsafe-code-audit]
    if: always()
    steps:
      - name: Generate security summary
        run: |
          echo "# Security Audit Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "- Cargo Audit: ${{ needs.cargo-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cargo Deny: ${{ needs.cargo-deny.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Clippy Security: ${{ needs.clippy-security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Unsafe Code Audit: ${{ needs.unsafe-code-audit.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.cargo-audit.result }}" == "failure" ] || \
             [ "${{ needs.cargo-deny.result }}" == "failure" ] || \
             [ "${{ needs.clippy-security.result }}" == "failure" ]; then
            echo "⚠️ **Security issues detected!** Please review the failed jobs above." >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **All security checks passed!**" >> $GITHUB_STEP_SUMMARY
          fi
